{% extends "admin_base.html" %}

{% block title %}Admin Dashboard | Manqinenyathi Food Supply{% endblock %}

{% block page_title %}Admin Dashboard{% endblock %}

{% block content %}


<!-- Dashboard Stats -->
<div class="row">
    <div class="col-md-3">
        <div class="dashboard-card">
            <div class="card-icon">
                <i class="fas fa-school"></i>
            </div>
            <h3>{{ total_schools }}</h3>
            <p>Schools Managed</p>
        </div>
    </div>
    <div class="col-md-3">
        <div class="dashboard-card">
            <div class="card-icon">
                <i class="fas fa-users"></i>
            </div>
            <h3>{{ total_workers }}</h3>
            <p>Total Workers</p>
        </div>
    </div>
    <div class="col-md-3">
        <div class="dashboard-card">
            <div class="card-icon">
                <i class="fas fa-utensils"></i>
            </div>
            <h3>{{ learners_fed_today }}</h3>
            <p>Learners Fed Today</p>
        </div>
    </div>
    <div class="col-md-3">
        <div class="dashboard-card">
            <div class="card-icon">
                <i class="fas fa-truck"></i>
            </div>
            <h3>{{ completed_deliveries_today }}/{{ total_deliveries_today }}</h3>
            <p>Deliveries Completed</p>
        </div>
    </div>
</div>

<!-- Second Row Stats -->
<div class="row">
    <div class="col-md-3">
        <div class="stats-card">
            <h5>Cookers Clocked In</h5>
            <h3>{{ cookers_clocked_in }}/{{ total_cookers }}</h3>
            <div class="trend {% if cookers_clocked_in == total_cookers %}up{% else %}down{% endif %}">
                <i class="fas fa-{% if cookers_clocked_in == total_cookers %}arrow-up{% else %}arrow-down{% endif %} me-1"></i>
                {% if cookers_clocked_in == total_cookers %}All present today{% else %}{{ total_cookers - cookers_clocked_in }} absent{% endif %}
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stats-card">
            <h5>Pending Deliveries</h5>
            <h3>{{ pending_deliveries }}</h3>
            <div class="trend {% if pending_deliveries == 0 %}up{% else %}down{% endif %}">
                <i class="fas fa-{% if pending_deliveries == 0 %}arrow-up{% else %}arrow-down{% endif %} me-1"></i>
                {% if pending_deliveries == 0 %}All clear{% else %}Needs attention{% endif %}
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stats-card">
            <h5>Monthly Learners</h5>
            <h3>{{ monthly_learners }}</h3>
            <div class="trend up">
                <i class="fas fa-arrow-up me-1"></i> This month
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stats-card">
            <h5>Active Delivery Personnel</h5>
            <h3>{{ active_delivery_guys }}</h3>
            <div class="trend up">
                <i class="fas fa-arrow-up me-1"></i> On duty
            </div>
        </div>
    </div>
</div>

<!-- Charts and Tables Row -->
<div class="row">
    <!-- Recent Deliveries -->
    <div class="col-md-12">
        <div class="table-container">
            <h3><i class="fas fa-truck me-2"></i>Recent Deliveries</h3>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>School</th>
                            <th>Delivery Guy</th>
                            <th>Date</th>
                            <th>Status</th>
                            <th>Delivery Time</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for delivery in recent_deliveries %}
                        <tr>
                            <td>{{ delivery.school.school_name }}</td>
                            <td>{{ delivery.delivery_guy.full_name }}</td>
                            <td>{{ delivery.delivery_date.strftime('%Y-%m-%d') }}</td>
                            <td>
                                <span class="badge {% if delivery.status == 'Delivered' %}bg-success{% else %}bg-warning{% endif %}">
                                    {{ delivery.status }}
                                </span>
                            </td>
                            <td>
                                {% if delivery.delivered_time %}
                                    {{ delivery.delivered_time.strftime('%H:%M') }}
                                {% else %}
                                    <span class="text-muted">Pending</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="text-end">
                <a href="{{ url_for('manage_deliveries') }}" class="btn btn-sm btn-outline-primary">View All Deliveries</a>
            </div>
        </div>
    </div>
</div>

<!-- System Overview -->
<div class="row mt-4">
    <div class="col-md-6">
        <div class="stats-card">
            <h5>System Status</h5>
            <div class="system-status">
                <div class="status-item {% if total_schools > 0 %}online{% else %}offline{% endif %}">
                    <i class="fas fa-circle me-2"></i>
                    <span>Schools Management: {% if total_schools > 0 %}Active{% else %}No Data{% endif %}</span>
                </div>
                <div class="status-item {% if total_workers > 0 %}online{% else %}offline{% endif %}">
                    <i class="fas fa-circle me-2"></i>
                    <span>Workers System: {% if total_workers > 0 %}Active{% else %}No Data{% endif %}</span>
                </div>
                <div class="status-item {% if learners_fed_today > 0 %}online{% else %}offline{% endif %}">
                    <i class="fas fa-circle me-2"></i>
                    <span>Feeding Program: {% if learners_fed_today > 0 %}Active{% else %}No Activity{% endif %}</span>
                </div>
                <div class="status-item {% if completed_deliveries_today > 0 %}online{% else %}offline{% endif %}">
                    <i class="fas fa-circle me-2"></i>
                    <span>Delivery System: {% if completed_deliveries_today > 0 %}Active{% else %}No Deliveries{% endif %}</span>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="stats-card">
            <h5>Quick Actions</h5>
            <div class="quick-actions">
                <a href="{{ url_for('add_school') }}" class="quick-action-btn">
                    <i class="fas fa-plus me-1"></i> Add New School
                </a>
                <a href="{{ url_for('add_worker') }}" class="quick-action-btn">
                    <i class="fas fa-user-plus me-1"></i> Add Worker
                </a>
                <a href="{{ url_for('assign_delivery') }}" class="quick-action-btn">
                    <i class="fas fa-truck me-1"></i> Assign Delivery
                </a>
                <a href="{{ url_for('admin_reports') }}" class="quick-action-btn">
                    <i class="fas fa-file-export me-1"></i> View Reports
                </a>
                <a href="{{ url_for('admin_learner_records') }}" class="quick-action-btn">
                    <i class="fas fa-graduation-cap me-1"></i> Learner Records
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .notification-form {
        background-color: var(--light-gray);
        padding: 20px;
        border-radius: 8px;
        border-left: 4px solid var(--primary-purple);
    }
    
    .system-status {
        margin-top: 15px;
    }
    
    .status-item {
        display: flex;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid var(--medium-gray);
    }
    
    .status-item:last-child {
        border-bottom: none;
    }
    
    .status-item.online i {
        color: #28a745;
    }
    
    .status-item.offline i {
        color: #dc3545;
    }
    
    /* Quick Actions Update */
    .quick-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 15px;
    }
    
    .quick-action-btn {
        background-color: var(--primary-purple);
        color: white;
        border: none;
        border-radius: 5px;
        padding: 10px 15px;
        font-size: 14px;
        transition: background-color 0.3s;
        text-decoration: none;
        display: inline-block;
        text-align: center;
        flex: 1;
        min-width: 120px;
    }
    
    .quick-action-btn:hover {
        background-color: var(--dark-purple);
        color: white;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Notification System
        const notificationForm = document.getElementById('notificationForm');
        if (notificationForm) {
            notificationForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const notificationType = document.getElementById('notificationType').value;
                const targetRole = document.getElementById('targetRole').value;
                const message = document.getElementById('notificationMessage').value;
                
                if (!notificationType || !message) {
                    alert('Please fill in all required fields');
                    return;
                }
                
                // Send notification via AJAX
                fetch('/admin/send-notification', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        type: notificationType,
                        target_role: targetRole,
                        message: message
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Notification sent successfully!');
                        notificationForm.reset();
                    } else {
                        alert('Error sending notification: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error sending notification');
                });
            });
        }
        
        // Auto-refresh stats every 60 seconds
        setInterval(() => {
            window.location.reload();
        }, 60000);
    });
</script>
{% endblock %}